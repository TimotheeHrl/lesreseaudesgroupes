{"version":3,"sources":["../../../next-server/server/config-shared.ts"],"names":["debug","require","defaultConfig","env","webpack","webpackDevMiddleware","distDir","cleanDistDir","assetPrefix","configOrigin","useFileSystemPublicRoutes","generateBuildId","generateEtags","pageExtensions","target","poweredByHeader","compress","analyticsId","process","VERCEL_ANALYTICS_ID","images","imageConfigDefault","devIndicators","buildActivity","onDemandEntries","maxInactiveAge","pagesBufferLength","amp","canonicalBase","basePath","sassOptions","trailingSlash","i18n","productionBrowserSourceMaps","optimizeFonts","experimental","cpus","Math","max","Number","CIRCLE_NODE_TOTAL","os","length","plugins","profiling","sprFlushToDisk","workerThreads","pageEnv","optimizeImages","optimizeCss","scrollRestoration","stats","externalDir","reactRoot","NEXT_PRIVATE_REACT_ROOT","disableOptimizedLoading","gzipSize","craCompat","webpack5","NEXT_PRIVATE_TEST_WEBPACK4_MODE","undefined","excludeDefaultMomentLocales","future","strictPostcssConfiguration","serverRuntimeConfig","publicRuntimeConfig","reactStrictMode","normalizeConfig","phase","config","then","Error","getConfigSrcPath","dir","tsPath","jsPath","legacyPath","isInternalDevelopment","__dirname","match","VERCEL_BUILDER","console","log","__NEXT_TEST_MODE","tsPath2","jsPath2","legacyPath2","getCompiledConfigPath","CONFIG_FILE","compileConfig","srcPath","compiledPath","includes","pkgJsonPath","cwd","pkg","entryPoints","outfile","format","bundle","platform","external","Object","keys","dependencies","devDependencies"],"mappings":"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","sourcesContent":["import { existsSync, readFileSync } from 'fs'\nimport { build as esbuild } from 'esbuild'\nimport findUp from 'next/dist/compiled/find-up'\nimport os from 'os'\nimport { join } from 'path'\nimport { Header, Redirect, Rewrite } from '../../lib/load-custom-routes'\nimport { imageConfigDefault } from './image-config'\nimport { CONFIG_FILE } from '../lib/constants'\nimport { copy, remove } from 'fs-extra'\nconst debug = require('debug')('blitz:config')\n\nexport type DomainLocales = Array<{\n  http?: true\n  domain: string\n  locales?: string[]\n  defaultLocale: string\n}>\n\nexport type NextConfig = { [key: string]: any } & {\n  cleanDistDir?: boolean\n  i18n?: {\n    locales: string[]\n    defaultLocale: string\n    domains?: DomainLocales\n    localeDetection?: false\n  } | null\n\n  headers?: () => Promise<Header[]>\n  rewrites?: () => Promise<\n    | Rewrite[]\n    | {\n        beforeFiles: Rewrite[]\n        afterFiles: Rewrite[]\n        fallback: Rewrite[]\n      }\n  >\n  redirects?: () => Promise<Redirect[]>\n  trailingSlash?: boolean\n  webpack5?: false\n  excludeDefaultMomentLocales?: boolean\n\n  future: {\n    /**\n     * @deprecated this options was moved to the top level\n     */\n    webpack5?: false\n    strictPostcssConfiguration?: boolean\n  }\n  experimental: {\n    cpus?: number\n    plugins?: boolean\n    profiling?: boolean\n    sprFlushToDisk?: boolean\n    reactMode?: 'legacy' | 'concurrent' | 'blocking'\n    workerThreads?: boolean\n    pageEnv?: boolean\n    optimizeImages?: boolean\n    optimizeCss?: boolean\n    scrollRestoration?: boolean\n    stats?: boolean\n    externalDir?: boolean\n    conformance?: boolean\n    initServer?: () => void\n    amp?: {\n      optimizer?: any\n      validator?: string\n      skipValidation?: boolean\n    }\n    reactRoot?: boolean\n    disableOptimizedLoading?: boolean\n    gzipSize?: boolean\n    craCompat?: boolean\n  }\n}\n\nexport const defaultConfig: NextConfig = {\n  env: [],\n  webpack: null,\n  webpackDevMiddleware: null,\n  distDir: '.next',\n  cleanDistDir: true,\n  assetPrefix: '',\n  configOrigin: 'default',\n  useFileSystemPublicRoutes: true,\n  generateBuildId: () => null,\n  generateEtags: true,\n  pageExtensions: ['tsx', 'ts', 'jsx', 'js'],\n  target: 'server',\n  poweredByHeader: true,\n  compress: true,\n  analyticsId: process.env.VERCEL_ANALYTICS_ID || '',\n  images: imageConfigDefault,\n  devIndicators: {\n    buildActivity: true,\n  },\n  onDemandEntries: {\n    maxInactiveAge: 60 * 1000,\n    pagesBufferLength: 2,\n  },\n  amp: {\n    canonicalBase: '',\n  },\n  basePath: '',\n  sassOptions: {},\n  trailingSlash: false,\n  i18n: null,\n  productionBrowserSourceMaps: false,\n  optimizeFonts: true,\n  experimental: {\n    cpus: Math.max(\n      1,\n      (Number(process.env.CIRCLE_NODE_TOTAL) ||\n        (os.cpus() || { length: 1 }).length) - 1\n    ),\n    plugins: false,\n    profiling: false,\n    sprFlushToDisk: true,\n    workerThreads: false,\n    pageEnv: false,\n    optimizeImages: false,\n    optimizeCss: false,\n    scrollRestoration: false,\n    stats: false,\n    externalDir: false,\n    reactRoot: Number(process.env.NEXT_PRIVATE_REACT_ROOT) > 0,\n    disableOptimizedLoading: false,\n    gzipSize: true,\n    craCompat: false,\n  },\n  webpack5:\n    Number(process.env.NEXT_PRIVATE_TEST_WEBPACK4_MODE) > 0 ? false : undefined,\n  excludeDefaultMomentLocales: true,\n  future: {\n    strictPostcssConfiguration: false,\n  },\n  serverRuntimeConfig: {},\n  publicRuntimeConfig: {},\n  reactStrictMode: false,\n}\n\nexport function normalizeConfig(phase: string, config: any) {\n  if (typeof config === 'function') {\n    config = config(phase, { defaultConfig })\n\n    if (typeof config.then === 'function') {\n      throw new Error(\n        '> Promise returned in blitz config. https://nextjs.org/docs/messages/promise-in-next-config'\n      )\n    }\n  }\n  return config\n}\n\nexport async function getConfigSrcPath(dir: string | null) {\n  if (!dir) return null\n\n  let tsPath = join(dir, 'blitz.config.ts')\n  let jsPath = join(dir, 'blitz.config.js')\n  let legacyPath = join(dir, 'next.config.js')\n\n  if (existsSync(tsPath)) {\n    return tsPath\n  } else if (existsSync(jsPath)) {\n    return jsPath\n  } else if (existsSync(legacyPath)) {\n    const isInternalDevelopment = __dirname.match(\n      /[\\\\/]packages[\\\\/]next[\\\\/]dist[\\\\/]next-server/\n    )\n    if (isInternalDevelopment || process.env.VERCEL_BUILDER) {\n      // We read from next.config.js that Vercel automatically adds\n      debug(\n        'Using next.config.js because isInternalDevelopment or VERCEL_BUILDER...'\n      )\n      return legacyPath\n    } else {\n      console.log('') // newline\n      throw new Error(\n        'Blitz does not support next.config.js. Please rename it to blitz.config.js'\n      )\n    }\n  }\n\n  if (process.env.__NEXT_TEST_MODE) {\n    let tsPath2 = join(dir, '..', 'blitz.config.ts')\n    let jsPath2 = join(dir, '..', 'blitz.config.js')\n    let legacyPath2 = join(dir, '..', 'next.config.js')\n    if (existsSync(tsPath2)) {\n      return tsPath2\n    } else if (existsSync(jsPath2)) {\n      return jsPath2\n    } else if (existsSync(legacyPath2)) {\n      return legacyPath2\n    }\n  }\n\n  return null\n}\n\nexport function getCompiledConfigPath(dir: string) {\n  return join(dir, CONFIG_FILE)\n}\n\nexport async function compileConfig(dir: string | null) {\n  debug('Starting compileConfig...')\n\n  if (!dir) {\n    debug('compileConfig given empty dir argument')\n    return\n  }\n\n  const srcPath = await getConfigSrcPath(dir)\n  debug('srcPath:', srcPath)\n  const compiledPath = getCompiledConfigPath(dir)\n  debug('compiledPath:', compiledPath)\n\n  // Remove compiled file. This is important for example when user\n  // had a config file but then removed it\n  remove(compiledPath)\n\n  if (!srcPath) {\n    debug('Did not find a config file')\n    return\n  }\n\n  if (readFileSync(srcPath, 'utf8').includes('tsconfig-paths/register')) {\n    // User is manually handling their own typescript stuff\n    debug(\n      \"Config contains 'tsconfig-paths/register', so skipping build and just copying the file\"\n    )\n    await copy(srcPath, compiledPath)\n    return\n  }\n\n  const pkgJsonPath = await findUp('package.json', { cwd: dir })\n\n  if (!pkgJsonPath) {\n    // This will happen when running blitz no inside a blitz app\n    debug('Unable to find package directory')\n    return\n  }\n\n  debug('Building config...')\n  const pkg = require(pkgJsonPath)\n\n  await esbuild({\n    entryPoints: [srcPath],\n    outfile: compiledPath,\n    format: 'cjs',\n    bundle: true,\n    platform: 'node',\n    external: [\n      '*.json',\n      '@blitzjs',\n      '@next',\n      '@zeit',\n      'blitz',\n      'next',\n      'webpack',\n      ...Object.keys(require('blitz/package').dependencies),\n      ...Object.keys(pkg?.dependencies ?? {}),\n      ...Object.keys(pkg?.devDependencies ?? {}),\n    ],\n  })\n  debug('Config built.')\n}\n"]}